#!/bin/bash

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

source "$PROJECT_ROOT/config/toolkit.conf"
source "$PROJECT_ROOT/utils/logger.sh"

# Resolve absolute paths
LOG_FILE="$PROJECT_ROOT/$LOG_FILE"
REPORT_FILE="$PROJECT_ROOT/$REPORT_FILE"
BACKUP_DIR="$PROJECT_ROOT/$BACKUP_DIR"

# Create required directories
mkdir -p "$(dirname "$LOG_FILE")"
mkdir -p "$(dirname "$REPORT_FILE")"
mkdir -p "$BACKUP_DIR"

# Function: generate HTML report
generate_report() {

cat > "$REPORT_FILE" <<EOF
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>SentinelShell Daily Report</title>
<style>
body { font-family: Arial, sans-serif; background: #f4f6f8; padding: 20px; }
h1 { color: #222; }
.section { background: #fff; padding: 15px; margin-bottom: 20px; border-radius: 6px; box-shadow: 0 0 6px rgba(0,0,0,0.08); }
.section h2 { border-left: 4px solid #007bff; padding-left: 10px; color: #007bff; }
.ok { color: green; font-weight: bold; }
.warn { color: orange; font-weight: bold; }
.alert { color: red; font-weight: bold; }
pre { background: #f1f1f1; padding: 10px; overflow-x: auto; border-radius: 4px; }
footer { text-align: center; font-size: 12px; color: #777; margin-top: 20px; }
</style>
</head>
<body>

<h1>üõ° SentinelShell Daily Report</h1>
<p><strong>Host:</strong> $(hostname)</p>
<p><strong>Date:</strong> $(date)</p>

<div class="section">
<h2>üìä System Health</h2>
<pre>
$(uptime)
$(df -h /)
</pre>
</div>

<div class="section">
<h2>üì¶ Service Status</h2>
<pre>
$(for s in $SERVICES; do
    status=$(systemctl is-active $s 2>/dev/null)
    echo "$s : <span style='color:$( [ "$status" = "active" ] && echo green || echo red )'>$status</span>"
done)
</pre>
</div>

<div class="section">
<h2>üîê SSH Brute Force Attempts</h2>
<pre>
$(cat "$PROJECT_ROOT/reports/ssh_bruteforce.txt" 2>/dev/null || echo "No suspicious activity")
</pre>
</div>

<div class="section">
<h2>üö´ Permission Violations</h2>
<pre>
$(cat "$PROJECT_ROOT/reports/permission_violations.txt" 2>/dev/null || echo "No violations detected")
</pre>
</div>

<div class="section">
<h2>üíæ Backup Summary</h2>
<pre>
$(ls -lh "$BACKUP_DIR" | tail -n 5)
</pre>
</div>

<div class="section">
<h2>üìú Recent Logs</h2>
<pre>
$(tail -n 20 "$LOG_FILE")
</pre>
</div>

<footer>
Generated by SentinelShell ‚Ä¢ Automated Linux Monitoring Toolkit
</footer>

</body>
</html>
EOF

log "HTML report generated at $REPORT_FILE"
}

# Function: send report via email with attachment
send_email_report() {

    local subject="SentinelShell Daily Report - $(hostname)"
    local attachment="$REPORT_FILE"

    # msmtp configuration path
    local msmtp_config="$HOME/.msmtprc"
    [ "$EUID" -eq 0 ] && msmtp_config="/root/.msmtprc"

    if [ -f "$attachment" ]; then
        {
            echo "To: $ALERT_EMAIL"
            echo "Subject: $subject"
            echo "MIME-Version: 1.0"
            echo "Content-Type: multipart/mixed; boundary=report-boundary"
            echo
            echo "--report-boundary"
            echo "Content-Type: text/html; charset=UTF-8"
            echo "Content-Transfer-Encoding: 7bit"
            echo
            cat "$attachment"
            echo
            echo "--report-boundary"
            echo "Content-Type: text/html; name=\"$(basename "$attachment")\""
            echo "Content-Disposition: attachment; filename=\"$(basename "$attachment")\""
            echo "Content-Transfer-Encoding: 7bit"
            echo
            cat "$attachment"
            echo
            echo "--report-boundary--"
        } | msmtp --file="$msmtp_config" "$ALERT_EMAIL"

        log "HTML report emailed to $ALERT_EMAIL (attached as $(basename "$attachment"))"
    else
        log "Report file not found: $attachment"
    fi
}

# Generate & send report
generate_report
send_email_report
